<!DOCTYPE html>
<html>
<head>
    <title>Quick Cookie Test</title>
    <style>
        body { font-family: Arial; padding: 40px; background: #f5f5f5; }
        .box { background: white; padding: 30px; border-radius: 10px; max-width: 700px; margin: 0 auto; }
        button { 
            background: #3498db; color: white; border: none; padding: 15px 30px; 
            margin: 10px 5px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
        }
        button:hover { background: #2980b9; }
        .log { 
            background: #2c3e50; color: #ecf0f1; padding: 20px; border-radius: 5px; 
            font-family: monospace; margin-top: 20px; white-space: pre-wrap; 
            max-height: 500px; overflow-y: auto;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        input { padding: 12px; margin: 5px; width: 300px; font-size: 14px; border: 2px solid #ddd; border-radius: 5px; }
        h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="box">
        <h1>üîê Refresh Token Quick Test</h1>
        
        <h2>Step 1: Login First</h2>
        <input type="email" id="email" placeholder="Your email" value="">
        <input type="password" id="password" placeholder="Your password" value="">
        <br>
        <button onclick="login()">üîë LOGIN</button>
        
        <h2>Step 2: Test Refresh</h2>
        <button onclick="testRefresh()">üîÑ Test Refresh Token</button>
        <button onclick="checkCookies()">üç™ Show All Cookies</button>
        
        <div class="log" id="log">Ready. Click LOGIN first, then test refresh.</div>
    </div>

    <script>
        const API = 'http://localhost:5000';
        
        function log(msg, type = 'info') {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const cls = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            el.innerHTML += `<span class="${cls}">[${time}] ${msg}</span>\n`;
            el.scrollTop = el.scrollHeight;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('‚ùå Enter email and password', 'error');
                return;
            }

            log('üîÑ Logging in...', 'info');
            try {
                const res = await fetch(`${API}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    log(`‚ùå Login failed: ${err.error}`, 'error');
                    return;
                }
                
                const data = await res.json();
                log('‚úÖ Login successful!', 'success');
                log(`   - Access token: ${data.accessToken ? 'YES ‚úÖ' : 'NO ‚ùå'}`, 'success');
                log(`   - Role: ${data.role}`, 'success');
                
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('role', data.role);
                }
                
                log('‚ö†Ô∏è Now check if refreshToken cookie was set:', 'warning');
                log('   Open DevTools ‚Üí Application ‚Üí Cookies ‚Üí http://localhost:5000', 'warning');
                log('   Look for: refreshToken (httpOnly)', 'warning');
                
                // Wait then test refresh
                setTimeout(() => {
                    log('\nüîç Auto-testing refresh in 2 seconds...', 'info');
                    setTimeout(testRefresh, 2000);
                }, 1000);
                
            } catch (err) {
                log(`‚ùå Network error: ${err.message}`, 'error');
            }
        }

        async function testRefresh() {
            log('\nüîÑ Testing refresh endpoint...', 'info');
            try {
                const res = await fetch(`${API}/api/auth/refresh`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                log(`Response status: ${res.status}`, res.ok ? 'success' : 'error');
                const data = await res.json();
                
                if (res.ok && data.accessToken) {
                    log('‚úÖ‚úÖ‚úÖ SUCCESS! Refresh token works!', 'success');
                    log(`   - New access token: ${data.accessToken.substring(0, 40)}...`, 'success');
                    log(`   - Role: ${data.role}`, 'success');
                    log('\nüéâ YOUR REFRESH TOKEN SYSTEM IS WORKING!', 'success');
                } else {
                    log(`‚ùå Refresh failed: ${data.error}`, 'error');
                    log('\n‚ùå DIAGNOSIS:', 'error');
                    if (data.error === 'Nuk ka refresh token') {
                        log('   The backend says: "No refresh token"', 'error');
                        log('   This means the refreshToken COOKIE was not sent.', 'error');
                        log('\nüí° SOLUTIONS:', 'warning');
                        log('   1. Did you LOGIN first? (Use the button above)', 'warning');
                        log('   2. Check DevTools ‚Üí Application ‚Üí Cookies ‚Üí localhost:5000', 'warning');
                        log('   3. Is there a "refreshToken" cookie?', 'warning');
                        log('   4. If NO cookie: Backend did not set it during login', 'warning');
                        log('   5. If YES cookie: Check cookie domain/path settings', 'warning');
                    } else {
                        log(`   Error: ${data.error}`, 'error');
                    }
                }
            } catch (err) {
                log(`‚ùå Network error: ${err.message}`, 'error');
            }
        }

        function checkCookies() {
            log('\nüç™ Document cookies:', 'info');
            const cookies = document.cookie;
            if (cookies) {
                log(`   ${cookies}`, 'info');
            } else {
                log('   (none visible to JavaScript)', 'info');
            }
            log('\n‚ö†Ô∏è NOTE: httpOnly cookies (like refreshToken) are hidden from JavaScript', 'warning');
            log('   You must check in DevTools ‚Üí Application ‚Üí Cookies', 'warning');
        }
    </script>
</body>
</html>

